WITH AllMonths AS (
  SELECT TO_CHAR(TO_DATE('01-' || LEVEL || '-2000', 'DD-MM-YYYY'), 'MM') AS MONTH_NUM
    FROM DUAL
  CONNECT BY LEVEL <= 12
),
YearMonths AS (
  SELECT DISTINCT TO_CHAR(CHECK_IN, 'YYYY') AS CHART_YEAR
  FROM COMPANION_VIEW
  WHERE TO_CHAR(CHECK_IN, 'YYYY') BETWEEN :P16_YEAR_FROM AND :P16_YEAR_TO
)
SELECT YM.CHART_YEAR,
       AM.MONTH_NUM AS CHART_MONTH_NUM,
       TO_CHAR(TO_DATE(AM.MONTH_NUM, 'MM'), 'Month', 'NLS_DATE_LANGUAGE = American') AS MONTH_LABEL,
       NVL(COUNT(CV.CHECK_IN), 0) AS DATA_COUNT
  FROM AllMonths AM
       CROSS JOIN YearMonths YM
       LEFT JOIN COMPANION_VIEW CV
       ON TO_CHAR(CV.CHECK_IN, 'MM') = AM.MONTH_NUM
          AND TO_CHAR(CV.CHECK_IN, 'YYYY') = YM.CHART_YEAR
GROUP BY YM.CHART_YEAR, AM.MONTH_NUM, TO_CHAR(TO_DATE(AM.MONTH_NUM, 'MM'), 'Month', 'NLS_DATE_LANGUAGE = American')
ORDER BY YM.CHART_YEAR, AM.MONTH_NUM;

