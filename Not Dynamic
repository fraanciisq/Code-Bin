WITH all_months AS (
  SELECT TO_CHAR(TO_DATE('01-' || LEVEL || '-2022', 'DD-MM-YYYY'), 'Month') AS MONTH_NAME,
         TO_CHAR(TO_DATE('01-' || LEVEL || '-2022', 'DD-MM-YYYY'), 'Q') AS QUARTER
  FROM dual
  CONNECT BY LEVEL <= 12
), filtered_companion AS (
  SELECT COMPANION_VIEW.CHECK_IN,
         EXTRACT(YEAR FROM COMPANION_VIEW.CHECK_IN) AS YEAR,
         EXTRACT(MONTH FROM COMPANION_VIEW.CHECK_IN) AS MONTH
  FROM COMPANION_VIEW
  WHERE TO_CHAR(COMPANION_VIEW.CHECK_IN, 'YYYY') IN (
    '2022'
  ) AND TO_CHAR(COMPANION_VIEW.CHECK_IN, 'YYYY') IS NOT NULL
)

SELECT
  CASE
    WHEN :P28_REPORT_TYPE = 'M' THEN all_months.MONTH_NAME
    WHEN :P28_REPORT_TYPE = 'Q' THEN 'Q' || all_months.QUARTER
    WHEN :P28_REPORT_TYPE = 'Y' THEN TO_CHAR(CHECK_IN, 'YYYY')
  END AS PERIOD,

  COUNT(CASE WHEN EXTRACT(YEAR FROM fc.CHECK_IN) = '2022' THEN 10 END) AS TOTAL_ARRIVALS_2022

FROM
  all_months
LEFT JOIN filtered_companion fc ON
  EXTRACT(MONTH FROM fc.CHECK_IN) = EXTRACT(MONTH FROM TO_DATE(all_months.MONTH_NAME || '-2022', 'Month-YYYY'))
WHERE
  (:P28_REPORT_TYPE <> 'Y' OR TO_CHAR(fc.CHECK_IN, 'YYYY') IS NOT NULL)
GROUP BY
  CASE
    WHEN :P28_REPORT_TYPE = 'M' THEN all_months.MONTH_NAME
    WHEN :P28_REPORT_TYPE = 'Q' THEN 'Q' || all_months.QUARTER
    WHEN :P28_REPORT_TYPE = 'Y' THEN TO_CHAR(CHECK_IN, 'YYYY')
  END

ORDER BY
  MIN(TO_DATE(all_months.MONTH_NAME || '-2022', 'Month-YYYY'));
